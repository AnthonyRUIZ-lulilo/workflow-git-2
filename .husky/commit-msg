#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

first_line=$(head -n1 "$1")

# Autoriser les commits de merge, revert et automated
if echo "$first_line" | grep -qE '^(Merge( branch)?|Revert |\[Automated\])'; then
  echo "‚úÖ Commit de merge/revert/automated d√©tect√©, validation ignor√©e"
  exit 0
fi

# Types autoris√©s + scope OBLIGATOIRE + breaking change optionnel + sujet sans point final
# Format: <type>(scope)[!]: <description>
# TYPE ET SCOPE DOIVENT √äTRE EN MINUSCULES
regex='^(feat|fix|hotfix|style|refactor|test|chore|docs)\([a-z0-9/_-]+\)(!)?:\s.+[^.]$'

if echo "$first_line" | grep -Eq "$regex"; then
  # V√©rif longueur du sujet (apr√®s ": ")
  subject="${first_line#*: }"
  if [ ${#subject} -le 72 ]; then
    echo "‚úÖ Format de commit valide"
    exit 0
  else
    echo "‚ùå Sujet trop long (${#subject} caract√®res, max 72)"
    exit 1
  fi
else
  echo "‚ùå Format de commit invalide"
  echo ""
  echo "üìñ Format requis: <type>(scope)[!]: <description>"
  echo "   ‚ö†Ô∏è  Le type doit √™tre en minuscules"
  echo "   ‚ö†Ô∏è  Le scope doit √™tre en minuscules"
  echo "   ‚ö†Ô∏è  Le scope est OBLIGATOIRE"
  echo "   ‚ö†Ô∏è  La description ne doit PAS finir par un point"
  echo ""
  echo "‚úÖ Exemples valides:"
  echo "   ‚Ä¢ feat(auth): ajouter le dark mode"
  echo ""
  echo "‚ùå Exemples invalides:"
  echo "   ‚Ä¢ feat(Auth): scope avec majuscule"
  exit 1
fi