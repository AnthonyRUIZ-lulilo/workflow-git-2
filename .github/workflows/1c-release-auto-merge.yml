name: release-auto-merge

on:
  pull_request:
    branches: [main]
    types: [closed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge-release-please:
    name: Auto-merge release-please PR
    if: >
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'main' &&
      github.event.pull_request.head.ref == 'develop'
    runs-on: ubuntu-latest

    steps:
      - name: Find release-please PR
        id: find-pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: 'main'
            });

            const releasePR = prs.find(pr => pr.head.ref.startsWith('release-please--'));

            if (!releasePR) {
              console.log('‚ùå No release-please PR found');
              return null;
            }

            console.log(`‚úÖ Found release-please PR #${releasePR.number}: ${releasePR.title}`);
            return releasePR.number;

      - name: Wait for changelog workflow
        if: steps.find-pr.outputs.result != 'null'
        run: |
          echo "‚è≥ Waiting 60 seconds for changelog workflow to complete..."
          sleep 60

      - name: Check PR status
        if: steps.find-pr.outputs.result != 'null'
        id: check-pr
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.find-pr.outputs.result }};

            try {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });

              console.log(`PR #${prNumber} state: mergeable=${pr.mergeable}, mergeable_state=${pr.mergeable_state}`);

              if (pr.mergeable === false) {
                core.warning('‚ö†Ô∏è PR is not mergeable (conflicts detected)');
                return false;
              }

              if (pr.state !== 'open') {
                core.warning('‚ö†Ô∏è PR is not open anymore');
                return false;
              }

              return true;
            } catch (error) {
              core.setFailed(`Failed to check PR status: ${error.message}`);
              return false;
            }

      - name: Merge release-please PR
        if: steps.find-pr.outputs.result != 'null' && steps.check-pr.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.find-pr.outputs.result }};

            try {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });

              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'merge',
                commit_title: pr.title,
                commit_message: `${pr.body || ''}\n\nü§ñ Auto-merged by release-auto-merge workflow\nTriggered after develop was merged to main.`
              });

              console.log(`‚úÖ Release-please PR #${prNumber} merged successfully!`);
            } catch (error) {
              core.setFailed(`‚ùå Failed to merge release-please PR: ${error.message}`);
            }

      - name: Skip merge
        if: steps.find-pr.outputs.result == 'null' || steps.check-pr.outputs.result != 'true'
        run: |
          echo "‚è≠Ô∏è Skipping auto-merge (PR not found or not ready)"
